name: Live API Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1"

jobs:
  live-tests:
    name: Live integration tests (opt-in)
    runs-on: ubuntu-latest

    env:
      RPDBAPI_RUN_LIVE: "true"
      NOT_CRAN: "true"

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          needs: check
          extra-packages: any::pkgload, any::testthat

      - name: Run live API tests
        shell: Rscript {0}
        run: |
          library(pkgload)
          load_all(".")
          live_files <- c(
            "tests/testthat/test_query_search.R",
            "tests/testthat/test_perform_search.R",
            "tests/testthat/test_get_info.R",
            "tests/testthat/test_get_fasta_from_rcsb_entry.R",
            "tests/testthat/test_find_results.R",
            "tests/testthat/test_get_pdb_file.R"
          )
          for (f in live_files) {
            testthat::test_file(f)
          }
